import requests
from typing import Set


class ExploitChecker:
    """
    Checks CVE IDs against the CISA Known Exploited Vulnerabilities (KEV) catalog.
    Data is fetched once and cached in memory to avoid repeated downloads.
    """

    FEED_URL = "https://www.cisa.gov/sites/default/files/feeds/known_exploited_vulnerabilities.json"

    def __init__(self):
        self._kev_set: Set[str] = set()
        self._loaded = False

    def load_kev_data(self):
        """Fetch and cache KEV data. Safe to call multiple times; fetch happens once."""
        if self._loaded:
            return
        self._loaded = True  # ensure we don't retry endlessly
        try:
            resp = requests.get(self.FEED_URL, timeout=5)
            resp.raise_for_status()
            payload = resp.json()
            vulns = payload.get("vulnerabilities", [])
            for item in vulns:
                cve = item.get("cveID")
                if cve:
                    self._kev_set.add(cve.upper())
        except Exception:
            # Network errors are ignored; KEV checks will return False.
            self._kev_set = set()

    def check_cve(self, cve_id: str) -> bool:
        """Return True if the CVE exists in the KEV list."""
        if not cve_id:
            return False
        if not self._loaded:
            self.load_kev_data()
        return cve_id.upper() in self._kev_set
